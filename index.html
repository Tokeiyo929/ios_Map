<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏公司求职地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .toggle-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 320px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .toggle-item:last-child {
            margin-bottom: 0;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            margin-right: 16px;
        }

        .toggle-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 12px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4f46e5;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .company-popup {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 300px;
        }

        .city-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-count {
            background: #4f46e5;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
        }

        .nearby-cities {
            background: #f9fafb;
            border-left: 3px solid #10b981;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 13px;
        }

        .nearby-cities strong {
            color: #047857;
            margin-bottom: 4px;
            display: block;
        }

        .company-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .company-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .company-item:last-child {
            border-bottom: none;
        }

        .company-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .company-details {
            font-size: 13px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="toggle-container">
        <div class="toggle-item">
            <span class="toggle-label">仅显示英语区汉语区及日语区</span>
            <label class="toggle-switch">
                <input type="checkbox" id="country-filter-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="toggle-divider"></div>
        
        <div class="toggle-item">
            <span class="toggle-label">隐藏40Km唯一公司城市</span>
            <label class="toggle-switch">
                <input type="checkbox" id="single-company-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="toggle-divider"></div>
        
        <div class="toggle-item">
            <span class="toggle-label">隐藏人均GDP低于中国的国家</span>
            <label class="toggle-switch">
                <input type="checkbox" id="gdp-filter-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 目标国家列表
        const TARGET_COUNTRIES = new Set([
            '美国', '英格兰', '爱尔兰', '威尔士', '苏格兰', '加拿大', '澳大利亚', 
            '新西兰', '南非', '印度', '巴基斯坦', '菲律宾', '新加坡', '马来西亚', 
            '中国香港', '中国台湾', '日本', '中国'
        ]);

        // 中国的人均GDP值
        const CHINA_GDP_PER_CAPITA = 12970.6056414327;

        // 初始化地图
        const map = L.map('map').setView([35, 105], 4);

        // 添加地图图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 标记管理
        const markers = [];
        let allCities = {};
        let countryFilterEnabled = false;
        let hideSingleCompanyEnabled = false;
        let gdpFilterEnabled = false;

        // 创建城市标记
        function createCityMarker(city) {
            const companyCount = city.companies.length;
            const { size, color } = getMarkerConfig(companyCount);

            const marker = L.circleMarker([city.lat, city.lng], {
                radius: size,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });

            marker.bindPopup(createPopupContent(city));
            
            markers.push({
                marker,
                city: city.name,
                country: city.country,
                companyCount,
                hasNearbyCity: city.has_nearby_city,
                gdpPerCapita: city.gdp_per_capita || 0 // 添加人均GDP信息
            });

            return marker;
        }

        // 获取标记配置
        function getMarkerConfig(companyCount) {
            if (companyCount <= 16) {
                return { size: 10, color: '#4ade80' };
            } else if (companyCount <= 25) {
                return { size: 16, color: '#f59e0b' };
            } else {
                return { size: 22, color: '#ef4444' };
            }
        }

        // 创建弹窗内容
        function createPopupContent(city) {
            let nearbyCitiesInfo = '';
            if (city.has_nearby_city && city.nearby_cities) {
                nearbyCitiesInfo = `
                    <div class="nearby-cities">
                        <strong>附近城市:</strong>
                        ${city.nearby_cities.map(nearby => `
                            <div>${nearby.name} (${nearby.distance}km)</div>
                        `).join('')}
                    </div>
                `;
            }
            
            // 添加人均GDP信息到弹窗
            let gdpInfo = '';
            if (city.gdp_per_capita) {
                gdpInfo = `<div style="font-size:12px; color:#666; margin-top:5px;">
                    人均GDP: $${city.gdp_per_capita.toFixed(2)}
                </div>`;
            }

            return `
                <div class="company-popup">
                    <div class="city-title">
                        ${city.name}, ${city.country}
                        <span class="company-count">${city.companies.length}</span>
                    </div>
                    ${gdpInfo}
                    ${nearbyCitiesInfo}
                    <div class="company-list">
                        ${city.companies.map(company => `
                            <div class="company-item">
                                <div class="company-name">${company.name}</div>
                                <div class="company-details">${company.city}, ${company.country}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 检查标记是否应该显示
        function shouldShowMarker(marker) {
            // 国家过滤条件
            const countryCondition = !countryFilterEnabled || TARGET_COUNTRIES.has(marker.country);
            
            // 单公司过滤条件
            const singleCompanyCondition = !hideSingleCompanyEnabled || 
                                         marker.companyCount > 1 || 
                                         (marker.companyCount === 1 && marker.hasNearbyCity);
            
            // GDP过滤条件
            const gdpCondition = !gdpFilterEnabled || 
                               !marker.gdpPerCapita || 
                               marker.gdpPerCapita >= CHINA_GDP_PER_CAPITA;
            
            return countryCondition && singleCompanyCondition && gdpCondition;
        }

        // 更新标记显示
        function updateMarkersVisibility() {
            // 清除所有现有标记
            markers.forEach(item => {
                if (map.hasLayer(item.marker)) {
                    map.removeLayer(item.marker);
                }
            });

            // 添加符合条件的标记
            markers.forEach(item => {
                if (shouldShowMarker(item)) {
                    item.marker.addTo(map);
                }
            });
        }

        // 切换国家过滤器
        function toggleCountryFilter() {
            countryFilterEnabled = document.getElementById('country-filter-toggle').checked;
            updateMarkersVisibility();
        }

        // 切换单公司过滤器
        function toggleSingleCompanyFilter() {
            hideSingleCompanyEnabled = document.getElementById('single-company-toggle').checked;
            updateMarkersVisibility();
        }

        // 切换GDP过滤器
        function toggleGdpFilter() {
            gdpFilterEnabled = document.getElementById('gdp-filter-toggle').checked;
            updateMarkersVisibility();
        }

        // 加载数据并创建标记
        async function loadData() {
            try {
                // 加载数据文件
                await loadScript('cityCoordinates.js');
                await loadScript('gameCompaniesData.js');
                
                // 处理数据
                allCities = processCompaniesData(gameCompaniesData.companies, cityCoordinates);
                
                // 创建所有标记
                Object.values(allCities).forEach(city => {
                    const marker = createCityMarker(city);
                    marker.addTo(map);
                });

                // 只在初始加载时调整地图视野
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers.map(m => m.marker));
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // 添加切换事件监听
                document.getElementById('country-filter-toggle').addEventListener('change', toggleCountryFilter);
                document.getElementById('single-company-toggle').addEventListener('change', toggleSingleCompanyFilter);
                document.getElementById('gdp-filter-toggle').addEventListener('change', toggleGdpFilter);

            } catch (error) {
                console.error('数据加载失败:', error);
            }
        }

        // 加载脚本
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 处理公司数据
        function processCompaniesData(companies, cityCoords) {
            const cities = {};

            companies.forEach(company => {
                const cityKey = company.city;
                if (!cities[cityKey]) {
                    const coords = cityCoords[cityKey];
                    if (coords?.lat && coords?.lng) {
                        cities[cityKey] = {
                            name: company.city,
                            country: company.country,
                            lat: coords.lat,
                            lng: coords.lng,
                            has_nearby_city: coords.has_nearby_city || false,
                            nearby_cities: coords.nearby_cities || [],
                            gdp_per_capita: company.gdp_per_capita, // 保存人均GDP
                            companies: []
                        };
                    }
                }
                
                if (cities[cityKey]) {
                    cities[cityKey].companies.push(company);
                }
            });

            return cities;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
