<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¸æˆå…¬å¸æ±‚èŒåœ°å›¾</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --header-height: 120px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a2e;
            color: #e6e6e6;
            height: 100vh;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            overflow: hidden;
        }
        
        #header {
            background-color: #16213e;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1000;
        }
        
        h1 {
            margin: 0;
            color: #4cc9f0;
            font-size: 1.8rem;
            line-height: 1.2;
        }
        
        .subtitle {
            color: #a9b7c6;
            margin-top: 8px;
            font-size: 1rem;
        }
        
        #map-container {
            height: calc(100vh - var(--header-height) - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
            background-color: #1a1a2e;
        }
        
        .company-popup {
            max-width: 280px;
            max-height: 60vh;
            overflow: hidden;
        }
        
        .company-list {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }
        
        .company-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .company-list::-webkit-scrollbar-thumb {
            background-color: #4361ee;
            border-radius: 3px;
        }
        
        .company-item {
            padding: 12px;
            border-bottom: 1px solid #2d3746;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }
        
        .company-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .company-item:last-child {
            border-bottom: none;
        }
        
        .company-name {
            font-weight: bold;
            font-size: 1rem;
            color: #4cc9f0;
            margin-bottom: 5px;
        }
        
        .company-details {
            color: #a9b7c6;
            font-size: 0.85rem;
        }
        
        .city-title {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #72efdd;
            border-bottom: 1px solid #2d3746;
            padding-bottom: 8px;
        }
        
        .company-count {
            background-color: #4361ee;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(22, 33, 62, 0.95);
            padding: 12px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            max-width: 180px;
            backdrop-filter: blur(5px);
        }
        
        .legend-title {
            margin-top: 0;
            margin-bottom: 8px;
            color: #4cc9f0;
            font-size: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-circle {
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .legend-text {
            font-size: 0.85rem;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(22, 33, 62, 0.95);
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            color: #e6e6e6;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(239, 68, 68, 0.9);
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            color: white;
            text-align: center;
            max-width: 80%;
            backdrop-filter: blur(5px);
        }
        
        .error button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            max-width: 220px;
            backdrop-filter: blur(5px);
        }
        
        .control-title {
            margin-top: 0;
            margin-bottom: 12px;
            color: #4cc9f0;
            font-size: 1rem;
        }
        
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: #a9b7c6;
        }
        
        /* åˆ‡æ¢å¼€å…³æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2d3746;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4361ee;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* ç§»åŠ¨ç«¯ç‰¹å®šæ ·å¼ */
        .mobile-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-btn {
            background-color: rgba(22, 33, 62, 0.95);
            color: #e6e6e6;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            backdrop-filter: blur(5px);
        }
        
        .mobile-btn:active {
            background-color: rgba(22, 33, 62, 0.8);
        }
        
        /* é€‚é…å°å±å¹•çš„è°ƒæ•´ */
        @media (max-width: 414px) {
            :root {
                --header-height: 100px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            #header {
                padding: 12px 15px;
            }
            
            .legend {
                bottom: 10px;
                right: 10px;
                max-width: 160px;
                padding: 10px;
            }
            
            .control-panel {
                max-width: 180px;
                padding: 12px;
            }
        }
        
        /* é€‚é…æ¨ªå±æ¨¡å¼ */
        @media (max-height: 500px) and (orientation: landscape) {
            :root {
                --header-height: 70px;
            }
            
            #header {
                padding: 10px 15px;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .subtitle {
                display: none;
            }
            
            .control-panel {
                top: 5px;
                left: 5px;
                max-width: 160px;
                padding: 8px;
            }
        }
        
        /* åœ°å›¾å¼¹çª—æ ·å¼ä¼˜åŒ– */
        .leaflet-popup-content-wrapper {
            background-color: #16213e;
            color: #e6e6e6;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .leaflet-popup-tip {
            background-color: #16213e;
        }
        
        .leaflet-popup-close-button {
            color: #a9b7c6;
            font-size: 1.2rem;
            padding: 4px 8px;
        }
        
        .leaflet-popup-close-button:hover {
            color: #4cc9f0;
        }
        
        /* å…¬å¸çº§åˆ«æ ‡ç­¾ */
        .company-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 6px;
        }
        
        .level-1 {
            background-color: #4ade80;
            color: #1a1a2e;
        }
        
        .level-2 {
            background-color: #f59e0b;
            color: #1a1a2e;
        }
        
        .level-3 {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>æ¸¸æˆå…¬å¸æ±‚èŒåœ°å›¾</h1>
        <div class="subtitle">ç‚¹å‡»åŸå¸‚æ ‡è®°æŸ¥çœ‹è¯¥åœ°åŒºçš„æ¸¸æˆå…¬å¸ä¿¡æ¯</div>
    </div>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3 class="control-title">æ˜¾ç¤ºæ§åˆ¶</h3>
            <div class="toggle-group">
                <div class="toggle-item">
                    <span class="toggle-label">æ˜¾ç¤ºç¬¬ä¸€çº§åˆ«å…¬å¸</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-level-1" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">æ˜¾ç¤ºç¬¬äºŒçº§åˆ«å…¬å¸</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-level-2" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">æ˜¾ç¤ºç¬¬ä¸‰çº§åˆ«å…¬å¸</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-level-3" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="legend">
            <h3 class="legend-title">åŸå¸‚æ¸¸æˆå…¬å¸æ•°é‡</h3>
            <div class="legend-item">
                <div class="legend-circle" style="width: 10px; height: 10px; background-color: #4ade80;"></div>
                <div class="legend-text">1-16 å®¶å…¬å¸</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="width: 16px; height: 16px; background-color: #f59e0b;"></div>
                <div class="legend-text">17-25 å®¶å…¬å¸</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="width: 22px; height: 22px; background-color: #ef4444;"></div>
                <div class="legend-text">26+ å®¶å…¬å¸</div>
            </div>
        </div>
        <div id="loading" class="loading">
            <h3>åŠ è½½ä¸­...</h3>
            <p>æ­£åœ¨åŠ è½½æ¸¸æˆå…¬å¸æ•°æ®</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let map;
        let fitBoundsTimeout;
        let markers = [];
        let cities = {};
        
        // å¼‚æ­¥åŠ è½½æ•°æ®æ–‡ä»¶
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®æ–‡ä»¶...');
                
                // åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾åŠ è½½æ•°æ®
                await loadScript('cityCoordinates.js');
                await loadScript('gameCompaniesData.js');
                
                // éªŒè¯æ•°æ®
                if (typeof gameCompaniesData === 'undefined') {
                    throw new Error('gameCompaniesData æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ gameCompaniesData.js æ–‡ä»¶');
                }
                
                if (typeof cityCoordinates === 'undefined') {
                    throw new Error('cityCoordinates æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ cityCoordinates.js æ–‡ä»¶');
                }
                
                if (!gameCompaniesData.companies || !Array.isArray(gameCompaniesData.companies)) {
                    throw new Error('companies æ•°ç»„ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯');
                }
                
                console.log('æ•°æ®æ–‡ä»¶åŠ è½½æˆåŠŸ');
                
                // åˆå§‹åŒ–åº”ç”¨
                initApp();
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                showError('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`æˆåŠŸåŠ è½½: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`åŠ è½½å¤±è´¥: ${src}`);
                    reject(new Error(`æ— æ³•åŠ è½½è„šæœ¬: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        function showError(message) {
            const loadingEl = document.getElementById('loading');
            loadingEl.innerHTML = `
                <h3>é”™è¯¯</h3>
                <p>${message}</p>
                <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
            `;
            loadingEl.className = 'error';
        }

        function validateCompanyData(company) {
            return company && 
                   typeof company.name === 'string' && 
                   typeof company.city === 'string' && 
                   typeof company.country === 'string';
        }

        function getMarkerSize(companyCount) {
            if (companyCount <= 16) return 10;
            if (companyCount <= 25) return 16;
            return 22;
        }

        function getMarkerColor(companyCount) {
            if (companyCount <= 16) return '#4ade80';
            if (companyCount <= 25) return '#f59e0b';
            return '#ef4444';
        }

        function debouncedFitBounds(map, bounds) {
            clearTimeout(fitBoundsTimeout);
            fitBoundsTimeout = setTimeout(() => {
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { 
                        padding: [20, 20], 
                        maxZoom: 10,
                        animate: true
                    });
                }
            }, 100);
        }

        function initApp() {
            console.log('åˆå§‹åŒ–åº”ç”¨...');
            
            // éšè—åŠ è½½æç¤º
            document.getElementById('loading').style.display = 'none';
            
            // è°ƒè¯•ï¼šæ£€æŸ¥æ•°æ®
            console.log('åŸå¸‚åæ ‡æ•°æ®ç¤ºä¾‹:', Object.entries(cityCoordinates).slice(0, 3));
            console.log('å…¬å¸æ•°æ®ç¤ºä¾‹:', gameCompaniesData.companies.slice(0, 3));
            
            // åˆå§‹åŒ–åœ°å›¾ - è®¾ç½®ä¸ºä¸­å›½åŒºåŸŸ
            map = L.map('map').setView([35, 105], 4);
            
            // æ·»åŠ åœ°å›¾å›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
                minZoom: 1
            }).addTo(map);
            
            // æ·»åŠ è§¦æ‘¸äº¤äº’ä¼˜åŒ–
            map.touchZoom.enable();
            map.scrollWheelZoom.enable();
            map.dragging.enable();
            
            // é˜²æ­¢åœ°å›¾æ‹–åŠ¨æ—¶é¡µé¢æ»šåŠ¨
            map.on('dragstart', function() {
                document.body.style.overflow = 'hidden';
            });

            map.on('dragend', function() {
                document.body.style.overflow = '';
            });
            
            // å¤„ç†åŸå¸‚æ•°æ®ï¼ŒæŒ‰åŸå¸‚åˆ†ç»„
            let validCompanies = 0;
            let citiesWithCoords = 0;
            
            gameCompaniesData.companies.forEach(company => {
                if (!validateCompanyData(company)) {
                    console.warn('æ— æ•ˆçš„å…¬å¸æ•°æ®:', company);
                    return;
                }
                
                const cityKey = company.city;
                if (!cities[cityKey]) {
                    const coords = cityCoordinates[cityKey];
                    if (coords && coords.lat && coords.lng) {
                        citiesWithCoords++;
                        cities[cityKey] = {
                            name: company.city,
                            country: company.country,
                            lat: coords.lat,
                            lng: coords.lng,
                            companies: []
                        };
                    } else {
                        console.warn(`æœªæ‰¾åˆ°åŸå¸‚ "${cityKey}" çš„åæ ‡æˆ–åæ ‡æ ¼å¼é”™è¯¯`);
                    }
                }
                if (cities[cityKey]) {
                    cities[cityKey].companies.push(company);
                    validCompanies++;
                }
            });
            
            console.log(`æœ‰æ•ˆåŸå¸‚æ•°é‡: ${citiesWithCoords}`);
            console.log(`æˆåŠŸåŠ è½½ ${validCompanies} å®¶å…¬å¸æ•°æ®ï¼Œåˆ†å¸ƒåœ¨ ${Object.keys(cities).length} ä¸ªåŸå¸‚`);
            
            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆåŸå¸‚ï¼Œæ˜¾ç¤ºé”™è¯¯
            if (Object.keys(cities).length === 0) {
                showError('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åŸå¸‚åæ ‡æ•°æ®ã€‚è¯·æ£€æŸ¥ cityCoordinates.js æ–‡ä»¶ä¸­çš„åŸå¸‚åç§°æ˜¯å¦ä¸ gameCompaniesData.js ä¸­çš„åŸå¸‚åç§°åŒ¹é…ã€‚');
                return;
            }
            
            // æ·»åŠ æ‰€æœ‰æ ‡è®°
            addMarkers();
            
            // æ·»åŠ å®šä½æŒ‰é’®
            const locateControl = L.control({position: 'topright'});
            locateControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'mobile-btn');
                div.innerHTML = 'ğŸ“';
                div.title = 'å®šä½åˆ°æˆ‘çš„ä½ç½®';
                div.style.marginTop = '15px';
                div.style.fontSize = '1.2rem';
                div.style.padding = '8px 10px';
                
                div.onclick = function() {
                    map.locate({setView: true, maxZoom: 10});
                };
                
                return div;
            };
            locateControl.addTo(map);
            
            // å¤„ç†å®šä½æˆåŠŸ
            map.on('locationfound', function(e) {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("æ‚¨çš„å¤§æ¦‚ä½ç½®").openPopup();
            });
            
            // å¤„ç†å®šä½é”™è¯¯
            map.on('locationerror', function(e) {
                console.log('å®šä½å¤±è´¥:', e.message);
            });
            
            // æ·»åŠ åˆ‡æ¢äº‹ä»¶ç›‘å¬
            document.getElementById('toggle-level-1').addEventListener('change', updateMarkersVisibility);
            document.getElementById('toggle-level-2').addEventListener('change', updateMarkersVisibility);
            document.getElementById('toggle-level-3').addEventListener('change', updateMarkersVisibility);
            
            console.log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        }

        // æ·»åŠ æ‰€æœ‰æ ‡è®°åˆ°åœ°å›¾
        function addMarkers() {
            // è®¡ç®—æ‰€æœ‰åŸå¸‚çš„è¾¹ç•Œï¼Œç¡®ä¿åœ°å›¾æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
            const bounds = L.latLngBounds();
            let markersAdded = 0;
            
            // ä¸ºæ¯ä¸ªåŸå¸‚æ·»åŠ æ ‡è®°
            Object.values(cities).forEach(city => {
                const companyCount = city.companies.length;
                const markerSize = getMarkerSize(companyCount);
                const markerColor = getMarkerColor(companyCount);
                
                // æ‰©å±•è¾¹ç•Œ
                bounds.extend([city.lat, city.lng]);
                
                // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: markerSize,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.bindPopup(`
                    <div class="company-popup">
                        <div class="city-title">
                            ${city.name}, ${city.country}
                            <span class="company-count">${companyCount}</span>
                        </div>
                        <div class="company-list">
                            ${city.companies.map(company => {
                                // æ ¹æ®å…¬å¸è§„æ¨¡æˆ–å…¶ä»–æ ‡å‡†åˆ†é…çº§åˆ«
                                const level = assignCompanyLevel(company);
                                return `
                                <div class="company-item" data-level="${level}">
                                    <div class="company-name">${company.name}
                                        <span class="company-level level-${level}">${level}çº§</span>
                                    </div>
                                    <div class="company-details">${company.city}, ${company.country}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `, {
                    closeButton: true,
                    autoClose: false,
                    closeOnEscapeKey: true,
                    className: 'mobile-popup',
                    maxWidth: 300
                });
                
                // å­˜å‚¨æ ‡è®°ä¿¡æ¯
                markers.push({
                    marker: marker,
                    city: city.name,
                    companyCount: companyCount,
                    level: getCityLevel(companyCount)
                });
                
                // é»˜è®¤æ·»åŠ åˆ°åœ°å›¾
                marker.addTo(map);
                
                markersAdded++;
                console.log(`æ·»åŠ æ ‡è®°: ${city.name} (${city.lat}, ${city.lng}) - ${companyCount}å®¶å…¬å¸`);
            });
            
            console.log(`æˆåŠŸæ·»åŠ  ${markersAdded} ä¸ªæ ‡è®°`);
            
            // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
            if (bounds.isValid()) {
                debouncedFitBounds(map, bounds);
                console.log('åœ°å›¾å·²è°ƒæ•´åˆ°é€‚åˆæ‰€æœ‰æ ‡è®°çš„è§†å›¾');
            } else {
                // å¦‚æœè¾¹ç•Œæ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤è§†å›¾ä½†æ”¾å¤§ä¸€ç‚¹
                map.setView([35, 105], 5);
                console.log('ä½¿ç”¨é»˜è®¤åœ°å›¾è§†å›¾');
            }
        }

        // æ ¹æ®å…¬å¸æ•°é‡ç¡®å®šåŸå¸‚çº§åˆ«
        function getCityLevel(companyCount) {
            if (companyCount <= 16) return 1;
            if (companyCount <= 25) return 2;
            return 3;
        }

        // æ ¹æ®å…¬å¸å±æ€§åˆ†é…çº§åˆ«ï¼ˆè¿™é‡Œä½¿ç”¨ç®€åŒ–é€»è¾‘ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®å…¬å¸è§„æ¨¡ã€çŸ¥ååº¦ç­‰ç¡®å®šï¼‰
        function assignCompanyLevel(company) {
            // ç®€åŒ–é€»è¾‘ï¼šæ ¹æ®å…¬å¸åç§°é•¿åº¦åˆ†é…çº§åˆ«ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´åˆç†çš„æ ‡å‡†ï¼‰
            if (company.name.length <= 10) return 1;
            if (company.name.length <= 20) return 2;
            return 3;
        }

        // æ›´æ–°æ ‡è®°å¯è§æ€§
        function updateMarkersVisibility() {
            const showLevel1 = document.getElementById('toggle-level-1').checked;
            const showLevel2 = document.getElementById('toggle-level-2').checked;
            const showLevel3 = document.getElementById('toggle-level-3').checked;
            
            markers.forEach(item => {
                if (
                    (item.level === 1 && showLevel1) ||
                    (item.level === 2 && showLevel2) ||
                    (item.level === 3 && showLevel3)
                ) {
                    if (!map.hasLayer(item.marker)) {
                        item.marker.addTo(map);
                    }
                } else {
                    if (map.hasLayer(item.marker)) {
                        map.removeLayer(item.marker);
                    }
                }
            });
            
            // é‡æ–°è®¡ç®—è¾¹ç•Œ
            const bounds = L.latLngBounds();
            markers.forEach(item => {
                if (map.hasLayer(item.marker)) {
                    bounds.extend(item.marker.getLatLng());
                }
            });
            
            // è°ƒæ•´åœ°å›¾è§†å›¾
            if (bounds.isValid()) {
                debouncedFitBounds(map, bounds);
            }
        }

        // æ¸…ç†å‡½æ•°
        function cleanup() {
            if (map) {
                map.off();
                map.remove();
            }
        }

        // åœ¨DOMåŠ è½½å®Œæˆåå¼€å§‹åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ®...');
            loadData();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', cleanup);

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
            showError('å‘ç”Ÿé”™è¯¯: ' + e.message);
        });
    </script>
</body>
</html>
