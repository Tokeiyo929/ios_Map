<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¸æˆå…¬å¸æ±‚èŒåœ°å›¾</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a2e;
            color: #e6e6e6;
            height: 100vh;
            /* è€ƒè™‘iPhone 11çš„å®‰å…¨åŒºåŸŸ */
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            overflow: hidden;
        }
        
        #header {
            background-color: #16213e;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1000;
        }
        
        h1 {
            margin: 0;
            color: #4cc9f0;
            font-size: 1.8rem;
            line-height: 1.2;
        }
        
        .subtitle {
            color: #a9b7c6;
            margin-top: 8px;
            font-size: 1rem;
        }
        
        #map-container {
            height: calc(100vh - 120px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .company-popup {
            max-width: 280px;
            max-height: 60vh;
            overflow: hidden;
        }
        
        .company-list {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .company-item {
            padding: 12px;
            border-bottom: 1px solid #2d3746;
            margin-bottom: 5px;
        }
        
        .company-item:last-child {
            border-bottom: none;
        }
        
        .company-name {
            font-weight: bold;
            font-size: 1rem;
            color: #4cc9f0;
            margin-bottom: 5px;
        }
        
        .company-details {
            color: #a9b7c6;
            font-size: 0.85rem;
        }
        
        .city-title {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #72efdd;
            border-bottom: 1px solid #2d3746;
            padding-bottom: 8px;
        }
        
        .company-count {
            background-color: #4361ee;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(22, 33, 62, 0.95);
            padding: 12px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #e6e6e6;
            max-width: 180px;
        }
        
        .legend-title {
            margin-top: 0;
            margin-bottom: 8px;
            color: #4cc9f0;
            font-size: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-circle {
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .legend-text {
            font-size: 0.85rem;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(22, 33, 62, 0.95);
            padding: 20px;
            border-radius: 8px;
            z-index: 1001;
            color: #e6e6e6;
            text-align: center;
        }
        
        /* ç§»åŠ¨ç«¯ç‰¹å®šæ ·å¼ */
        .mobile-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mobile-btn {
            background-color: rgba(22, 33, 62, 0.95);
            color: #e6e6e6;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .mobile-btn:active {
            background-color: rgba(22, 33, 62, 0.8);
        }
        
        /* é€‚é…å°å±å¹•çš„è°ƒæ•´ */
        @media (max-width: 414px) {
            h1 {
                font-size: 1.6rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            #header {
                padding: 12px 15px;
            }
            
            #map-container {
                height: calc(100vh - 100px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            }
            
            .legend {
                bottom: 10px;
                right: 10px;
                max-width: 160px;
                padding: 10px;
            }
        }
        
        /* é€‚é…æ¨ªå±æ¨¡å¼ */
        @media (max-height: 500px) and (orientation: landscape) {
            #header {
                padding: 10px 15px;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .subtitle {
                display: none;
            }
            
            #map-container {
                height: calc(100vh - 70px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>æ¸¸æˆå…¬å¸æ±‚èŒåœ°å›¾</h1>
        <div class="subtitle">ç‚¹å‡»åŸå¸‚æ ‡è®°æŸ¥çœ‹è¯¥åœ°åŒºçš„æ¸¸æˆå…¬å¸ä¿¡æ¯</div>
    </div>
    <div id="map-container">
        <div id="map"></div>
        
        <div class="legend">
            <h3 class="legend-title">åŸå¸‚æ¸¸æˆå…¬å¸æ•°é‡</h3>
            <div class="legend-item">
                <div class="legend-circle" style="width: 10px; height: 10px; background-color: #4ade80;"></div>
                <div class="legend-text">1-5 å®¶å…¬å¸</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="width: 16px; height: 16px; background-color: #f59e0b;"></div>
                <div class="legend-text">6-15 å®¶å…¬å¸</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="width: 22px; height: 22px; background-color: #ef4444;"></div>
                <div class="legend-text">16+ å®¶å…¬å¸</div>
            </div>
        </div>
        <div id="loading" class="loading">
            <h3>åŠ è½½ä¸­...</h3>
            <p>æ­£åœ¨åŠ è½½æ¸¸æˆå…¬å¸æ•°æ®</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- å…ˆåŠ è½½æ•°æ®æ–‡ä»¶ -->
    <script src="cityCoordinates.js"></script>
    <script src="gameCompaniesData.js"></script>
    <!-- æœ€ååŠ è½½ä¸»é€»è¾‘ -->
    <script>
        // ä¸»åº”ç”¨é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ•°æ®æ˜¯å¦å·²åŠ è½½
            if (typeof gameCompaniesData === 'undefined' || typeof cityCoordinates === 'undefined') {
                document.getElementById('loading').innerHTML = '<h3>æ•°æ®åŠ è½½å¤±è´¥</h3><p>è¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½</p>';
                return;
            }
            
            // éšè—åŠ è½½æç¤º
            document.getElementById('loading').style.display = 'none';
            
            // åˆå§‹åŒ–åœ°å›¾ - è°ƒæ•´åˆå§‹è§†å›¾ä»¥é€‚åº”ç§»åŠ¨è®¾å¤‡
            const map = L.map('map').setView([30, 110], 3);
            
            // æ·»åŠ åœ°å›¾å›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                // ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–
                detectRetina: true,
                maxZoom: 18,
                minZoom: 1
            }).addTo(map);
            
            // æ·»åŠ è§¦æ‘¸äº¤äº’ä¼˜åŒ–
            map.touchZoom.enable();
            map.doubleClickZoom.disable();
            
            // æ ¹æ®å…¬å¸æ•°é‡è®¡ç®—æ ‡è®°å¤§å°
            function getMarkerSize(companyCount) {
                if (companyCount <= 5) return 10;
                if (companyCount <= 15) return 16;
                return 22;
            }

            // æ ¹æ®å…¬å¸æ•°é‡è®¡ç®—æ ‡è®°é¢œè‰²
            function getMarkerColor(companyCount) {
                if (companyCount <= 5) return '#4ade80';
                if (companyCount <= 15) return '#f59e0b';
                return '#ef4444';
            }

            // å¤„ç†åŸå¸‚æ•°æ®ï¼ŒæŒ‰åŸå¸‚åˆ†ç»„
            const cities = {};
            gameCompaniesData.companies.forEach(company => {
                const cityKey = company.city;
                if (!cities[cityKey]) {
                    const coords = cityCoordinates[cityKey];
                    if (coords) {
                        cities[cityKey] = {
                            name: company.city,
                            country: company.country,
                            lat: coords.lat,
                            lng: coords.lng,
                            companies: []
                        };
                    }
                }
                if (cities[cityKey]) {
                    cities[cityKey].companies.push(company);
                }
            });

            // ä¸ºæ¯ä¸ªåŸå¸‚æ·»åŠ æ ‡è®°
            Object.values(cities).forEach(city => {
                const companyCount = city.companies.length;
                const markerSize = getMarkerSize(companyCount);
                const markerColor = getMarkerColor(companyCount);
                
                // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: markerSize,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.bindPopup(`
                    <div class="company-popup">
                        <div class="city-title">
                            ${city.name}, ${city.country}
                            <span class="company-count">${companyCount}</span>
                        </div>
                        <div class="company-list">
                            ${city.companies.map(company => `
                                <div class="company-item">
                                    <div class="company-name">${company.name}</div>
                                    <div class="company-details">${company.city}, ${company.country}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `, {
                    // ç§»åŠ¨ç«¯ä¼˜åŒ–
                    closeButton: true,
                    autoClose: false,
                    closeOnEscapeKey: true,
                    className: 'mobile-popup'
                });
            });
            
            // æ·»åŠ ä¸€ä¸ªå®šä½æŒ‰é’®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
            const locateControl = L.control({position: 'topleft'});
            locateControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'mobile-btn');
                div.innerHTML = 'ğŸ“';
                div.title = 'å®šä½åˆ°æˆ‘çš„ä½ç½®';
                div.style.marginTop = '15px';
                div.style.fontSize = '1.2rem';
                div.style.padding = '8px 10px';
                
                div.onclick = function() {
                    map.locate({setView: true, maxZoom: 10});
                };
                
                return div;
            };
            locateControl.addTo(map);
            
            // å¤„ç†å®šä½æˆåŠŸ
            map.on('locationfound', function(e) {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("æ‚¨çš„å¤§æ¦‚ä½ç½®").openPopup();
            });
        });
    </script>
</body>
</html>
