<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏公司求职地图</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="toggle-container">
        <div class="toggle-item">
            <span class="toggle-label">仅显示英语区汉语区及日语区</span>
            <label class="toggle-switch">
                <input type="checkbox" id="country-filter-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="toggle-divider"></div>
        
        <div class="toggle-item">
            <span class="toggle-label">隐藏40Km唯一公司城市</span>
            <label class="toggle-switch">
                <input type="checkbox" id="single-company-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 目标国家列表
        const TARGET_COUNTRIES = new Set([
            '美国', '英格兰', '爱尔兰', '威尔士', '苏格兰', '加拿大', '澳大利亚', 
            '新西兰', '南非', '印度', '巴基斯坦', '菲律宾', '新加坡', '马来西亚', 
            '中国香港', '中国台湾', '日本', '韩国', '中国'
        ]);

        // 初始化地图
        const map = L.map('map').setView([35, 105], 4);

        // 添加地图图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 标记管理
        const markers = [];
        let allCities = {};
        let countryFilterEnabled = false;
        let hideSingleCompanyEnabled = false;

        // 创建城市标记
        function createCityMarker(city) {
            const companyCount = city.companies.length;
            const { size, color } = getMarkerConfig(companyCount);

            const marker = L.circleMarker([city.lat, city.lng], {
                radius: size,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });

            marker.bindPopup(createPopupContent(city));
            
            markers.push({
                marker,
                city: city.name,
                country: city.country,
                companyCount,
                hasNearbyCity: city.has_nearby_city // 添加附近城市信息
            });

            return marker;
        }

        // 获取标记配置
        function getMarkerConfig(companyCount) {
            if (companyCount <= 16) {
                return { size: 10, color: '#4ade80' };
            } else if (companyCount <= 25) {
                return { size: 16, color: '#f59e0b' };
            } else {
                return { size: 22, color: '#ef4444' };
            }
        }

        // 创建弹窗内容
        function createPopupContent(city) {
            let nearbyCitiesInfo = '';
            if (city.has_nearby_city && city.nearby_cities) {
                nearbyCitiesInfo = `
                    <div class="nearby-cities">
                        <strong>附近城市:</strong>
                        ${city.nearby_cities.map(nearby => `
                            <div>${nearby.name} (${nearby.distance}km)</div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div class="company-popup">
                    <div class="city-title">
                        ${city.name}, ${city.country}
                        <span class="company-count">${city.companies.length}</span>
                    </div>
                    ${nearbyCitiesInfo}
                    <div class="company-list">
                        ${city.companies.map(company => `
                            <div class="company-item">
                                <div class="company-name">${company.name}</div>
                                <div class="company-details">${company.city}, ${company.country}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 检查标记是否应该显示
        function shouldShowMarker(marker) {
            // 国家过滤条件
            const countryCondition = !countryFilterEnabled || TARGET_COUNTRIES.has(marker.country);
            
            // 修改后的单公司过滤条件：只有1家公司且没有附近城市的才隐藏
            const singleCompanyCondition = !hideSingleCompanyEnabled || 
                                         marker.companyCount > 1 || 
                                         (marker.companyCount === 1 && marker.hasNearbyCity);
            
            return countryCondition && singleCompanyCondition;
        }

        // 更新标记显示
        function updateMarkersVisibility() {
            // 清除所有现有标记
            markers.forEach(item => {
                if (map.hasLayer(item.marker)) {
                    map.removeLayer(item.marker);
                }
            });

            // 添加符合条件的标记
            markers.forEach(item => {
                if (shouldShowMarker(item)) {
                    item.marker.addTo(map);
                }
            });

            // 移除了自动调整地图视野的代码
            // 现在切换过滤器时不会改变当前的地图视野
        }

        // 切换国家过滤器
        function toggleCountryFilter() {
            countryFilterEnabled = document.getElementById('country-filter-toggle').checked;
            updateMarkersVisibility();
        }

        // 切换单公司过滤器
        function toggleSingleCompanyFilter() {
            hideSingleCompanyEnabled = document.getElementById('single-company-toggle').checked;
            updateMarkersVisibility();
        }

        // 加载数据并创建标记
        async function loadData() {
            try {
                // 加载数据文件
                await loadScript('cityCoordinates.js');
                await loadScript('gameCompaniesData.js');
                
                // 处理数据
                allCities = processCompaniesData(gameCompaniesData.companies, cityCoordinates);
                
                // 创建所有标记
                Object.values(allCities).forEach(city => {
                    const marker = createCityMarker(city);
                    marker.addTo(map);
                });

                // 只在初始加载时调整地图视野
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers.map(m => m.marker));
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // 添加切换事件监听
                document.getElementById('country-filter-toggle').addEventListener('change', toggleCountryFilter);
                document.getElementById('single-company-toggle').addEventListener('change', toggleSingleCompanyFilter);

            } catch (error) {
                console.error('数据加载失败:', error);
            }
        }

        // 加载脚本
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 处理公司数据
        function processCompaniesData(companies, cityCoords) {
            const cities = {};

            companies.forEach(company => {
                const cityKey = company.city;
                if (!cities[cityKey]) {
                    const coords = cityCoords[cityKey];
                    if (coords?.lat && coords?.lng) {
                        cities[cityKey] = {
                            name: company.city,
                            country: company.country,
                            lat: coords.lat,
                            lng: coords.lng,
                            has_nearby_city: coords.has_nearby_city || false, // 添加has_nearby_city信息
                            nearby_cities: coords.nearby_cities || [], // 添加附近城市信息
                            companies: []
                        };
                    }
                }
                
                if (cities[cityKey]) {
                    cities[cityKey].companies.push(company);
                }
            });

            return cities;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
